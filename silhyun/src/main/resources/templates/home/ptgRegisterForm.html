<!doctype html>
<html lang="zxx" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{home/layout}">

<head>
    <!-- metas -->
    <meta charset="utf-8">
    <meta name="author" content="pxdraft" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="keywords" content="ShopApp - eCommerce Bootstrap 5 Template" />
    <meta name="description" content="ShopApp - eCommerce Bootstrap 5 Template" />
    <!-- title -->
    <title>ShopApp - eCommerce Bootstrap 5 Template</title>
        <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.6.3.js" integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script>
    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    <style>
        .regi {
            width: 300px;
        }

        #btn {
            text-align: center;
        }

        #fileBtn {
            display: none;
        }

        img {
            width: 130px;
            height: 130px;
        }

        p {
            color: #999;
            font-size: .9em;
        }

        #attZone {
            width: 100%;
            min-height: 130px;
            padding: 10px;
            border: 1px solid #D2D6D6;
        }

        #attZone:empty:before {
            content: attr(data-placeholder);
            color: #999;
            font-size: .9em;
        }
    </style>
</head>

<body>
    <div layout:fragment="content">
        <!-- Skippy & Prload -->
        <!-- skippy -->
        <a id="skippy" class="skippy visually-hidden-focusable overflow-hidden" href="#content">
            <div class="container">
                <span class="u-skiplink-text">Skip to main content</span>
            </div>
        </a>
        <!-- End skippy -->
        <!-- Preload -->
        <!-- <div id="loading" class="loading-preloader">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div> -->
        <!-- End Preload -->
        <!-- Edn Skippy & Prload -->
        <!-- Size Chart  -->


        <!-- End Size Chart  -->
        <!-- 
    ========================
        Wrapper 
    ========================
    -->
        <div class="wrapper">
            <div class="header-height-bar"></div>
            <!-- Main -->
            <main>
                <!-- Page Title -->
                <div class="py-3 bg-gray-100">
                    <div class="container">
                        <div class="row align-items-center">
                            <div class="col-lg-6 my-2">
                                <h1 class="m-0 h4 text-center text-lg-start"></h1>
                            </div>
                            <div class="col-lg-6 my-2">
                                <ol
                                    class="breadcrumb dark-link m-0 small justify-content-center justify-content-lg-end">
                                    <li class="breadcrumb-item"><a class="text-nowrap" href="/"><i
                                                class="bi bi-home"></i>Home</a></li>
                                    <li class="breadcrumb-item text-nowrap active" aria-current="page">작가 등록</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Page Title -->
                <!-- Section -->
                <section class="section">
                    <div class="container">
                        <div class="row justify-content-center">
                            <div class="col-md-7">
                                <!-- Form -->
                                <form id="ptgRegiFrm" action="/shin/ptgRegiInsert" method="post">
                                    <!-- Heading -->
                                    <h6 class="mb-4 h3">작가 등록</h6>
                                    <!-- Billing details -->

                                    <div class="form-group mb-3">
                                        <label for="name_1" class="form-label">이름<span
                                                class="text-danger">*</span></label>
                                        <input type="text" id="name_1" class="form-control regi"
                                            th:value="${member.name}" readonly>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="id" class="form-label">아이디<span class="text-danger">*</span></label>
                                        <input type="text" id="id" name="ptgId" class="form-control regi"
                                            th:value="${member.id}" readonly>
                                    </div>
                                    <div class="form-group mb-3">
                                        <div class="row align-items-center">
                                            <label class="form-label col" for="email">이메일<span
                                                    class="text-danger">*</span></label>
                                        </div>
                                        <input type="text" class="form-control regi" id="email" name="email"
                                            th:value="${member.email}" readonly>
                                    </div>
                                    <div class="form-group mb-3">
                                        <div class="row align-items-center">
                                            <label class="form-label col" for="inst">인스타그램</label>
                                        </div>
                                        <input type="text" class="form-control regi" id="inst" name="inst" placeholder="">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label col" for="crn">사업자등록번호<span
                                                class="text-danger">*</span></label>
                                        <div class="d-flex">
                                            <input type="text" class="form-control regi" id="crn"
                                                placeholder="-을 제외한 10자리 숫자를 적어주세요" name="crn">
                                                <button type="button" class="btn btn-primary w-20 ms-2 crnBtn" id="btnId"
                                                value="No">사업자
                                                인증</button>
                                            </div>
                                            <div class="text-danger error-msg"></div>
                                    </div>
                                    <label class="form-label col">활동 지역<span class="text-danger">*</span></label>
                                    <div class="dropdown btn btn-white border" style="size: 100px; text-align: left;">
                                        <select id="selectOp" name="regionCd" style="border: 1px solid white;" required>
                                            <option value="">::선택::</option>
                                            <option value="01">서울</option>
                                            <option value="02">경기</option>
                                            <option value="03">인천</option>
                                            <option value="04">강원</option>
                                            <option value="05">대전/충청</option>
                                            <option value="06">대구</option>
                                            <option value="07">부산/울산</option>
                                            <option value="08">경상</option>
                                            <option value="09">광주/전라</option>
                                            <option value="10">제주</option>
                                        </select>
                                    </div><br><br>

                                    <label class="form-label col">활동 분야<span class="text-danger">*</span></label><br>
                                    <div class="form-check form-check-inline">
                                        <label class="form-check-label" for="B1">제품<input class="form-check-input"
                                                type="checkbox" name="fdCd" id="B1" value="B1"></label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <label class="form-check-label" for="B2">음식<input class="form-check-input"
                                                type="checkbox" name="fdCd" id="B2" value="B2"></label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <label class="form-check-label" for="B3">행사<input class="form-check-input"
                                                type="checkbox" name="fdCd" id="B3" value="B3"></label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <label class="form-check-label" for="B4">건축/인테리어<input class="form-check-input"
                                                type="checkbox" name="fdCd" id="B4" value="B4"></label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <label class="form-check-label" for="B5">패션<input class="form-check-input"
                                                type="checkbox" name="fdCd" id="B5" value="B5"></label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <label class="form-check-label" for="B6">프로필/화보<input class="form-check-input"
                                                type="checkbox" name="fdCd" id="B6" value="B6"></label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <label class="form-check-label" for="B7">웨딩<input class="form-check-input"
                                                type="checkbox" name="fdCd" id="B7" value="B7"></label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <label class="form-check-label" for="B8">일반스냅<input class="form-check-input"
                                                type="checkbox" name="fdCd" id="B8" value="B8"></label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <label class="form-check-label" for="B9">반려동물<input class="form-check-input"
                                                type="checkbox" name="fdCd" id="B9" value="B9"></label>
                                    </div><br><br>

                                    <label class="form-label col">포트폴리오<span class="text-danger">*</span></label><br>
                                    <table class="table table-border">
                                        <div id="zone">
                                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                                onclick="fileUpAction()">파일선택</button>
                                            <input type='file' id='fileBtn' multiple='multiple' accept="image/*" />
                                            <div id='attZone' data-placeholder='파일은 최대 3개까지 업로드 가능합니다.'></div>
                                        </div>
                                    </table>


                                    <button style="margin-top: 10px;" type="button" class="btn btn-primary w-20 ms-2"
                                        onclick="insertPtgRegi()">신청</button>
                                    <button style="margin-top: 10px;" type="button" class="btn btn-primary w-20 ms-2"
                                        onclick="location.href = '/'">취소</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- End Section -->
            </main>
            <!-- End Main -->
        </div>
        <!-- 
    ========================
       End Wrapper 
    ========================
    -->
        <!-- script start -->
        <!--bootstrap-->
        <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <!-- slick carousel -->
        <script src="/vendor/swiper/swiper-bundle.min.js"></script>
        <!-- magnific -->
        <script src="/vendor/magnific/jquery.magnific-popup.min.js"></script>
        <!-- isotope -->
        <script src="/vendor/isotope/isotope.pkgd.min.js"></script>
        <!-- count-down -->
        <script src="/vendor/count-down/jquery.countdown.min.js"></script>
        <!-- count-down -->
        <script src="/vendor/jarallax/jarallax-all.js"></script>
        <!-- Theme Js -->
        <script src="/js/custom.js"></script>
        <script src="/js/theme.js"></script>
        <!-- End script start -->
        <script>

            //📌사업자등록전보 진위확인 및 상태조회 서비스
            $('.btn.btn-primary.w-20.ms-2.crnBtn').on('click', function () {
                let b_no = $('input[name="crn"]').val()
                var data = {
                    "b_no": [b_no]
                }
                console.log(b_no)

                $.ajax({
                    url: "https://api.odcloud.kr/api/nts-businessman/v1/status?serviceKey=flAksztYZxKbLInc2tRUFueJockBytqC38SEfZrmIVJDDdEOKff8DULN%2FSEDFJQX2AFxyrhNlJwG0cuCHll6Iw%3D%3D", // serviceKey 값을 xxxxxx에 입력
                    type: "POST",
                    data: JSON.stringify(data), // json 을 string으로 변환하여 전송
                    dataType: "JSON",
                    contentType: "application/json",
                    accept: "application/json",
                    success: function (result) {
                        if (result.data[0].b_stt_cd == '01') {
                            alert("사업자등록번호가 인증되었습니다.")
                            $('.btn.btn-primary.w-20.ms-2.crnBtn').val('Yes')
                            $('.btn.btn-primary.w-20.ms-2.crnBtn').attr("disabled", true)
                        } else {
                            alert("국세청에 등록되지 않은 사업자등록번호입니다.")
                        }
                    },
                    error: function (result) {
                        console.log(result.responseText); //responseText의 에러메세지 확인
                    }
                });
            })

            //📌포트폴리오 파일 등록           
            function fileUpAction() {
                document.getElementById('fileBtn').click()
            }
            var attZone = document.getElementById('attZone');
            var btnAtt = document.getElementById('fileBtn')
            var selFiles = new Array();

            // 이미지와 체크 박스를 감싸고 있는 div 속성
            var divStyle = 'display:inline-block;position:relative;' +
                'width:150px;height:120px;margin:5px;z-index:1';
            // 미리보기 이미지 속성
            var imgStyle = 'width:100%;height:100%;z-index:none';
            // 이미지안에 표시되는 체크박스의 속성
            var chkStyle = 'width:30px;height:30px;position:absolute;font-size:10px;' +
                'right:0px;bottom:0px;z-index:999;background-color:rgba(255,255,255,0.1);color:#f00';

            btnAtt.onchange = function (e) {
                var files = e.target.files;
                var fileArr = Array.prototype.slice.call(files)
                for (f of fileArr) {
                    imageLoader(f);
                }
                if (selFiles.length > 3) { 
                    alert("3개의 파일까지지 업로드 됩니다.")
                }
                selFiles.splice(5)
            }

            //이미지 미리보기
            imageLoader = function (file) {
                selFiles.push(file);
                if (selFiles.length < 4) {
                    var reader = new FileReader();
                    reader.onload = function (ee) {
                        let img = document.createElement('img')
                        img.setAttribute('style', imgStyle)
                        img.src = ee.target.result;
                        attZone.appendChild(makeDiv(img, file));
                    }
                    reader.readAsDataURL(file);
                }
            }

            //사진 삭제 버튼 
            makeDiv = function (img, file) {
                var div = document.createElement('div')
                div.setAttribute('style', divStyle)
                var btn = document.createElement('input')
                btn.setAttribute('type', 'button')
                btn.setAttribute('value', 'x')
                btn.setAttribute('delFile', file.name);
                btn.setAttribute('style', chkStyle);
                btn.onclick = function (ev) {
                    var ele = ev.srcElement;
                    var delFile = ele.getAttribute('delFile');
                    for (var i = 0; i < selFiles.length; i++) {
                        if (delFile == selFiles[i].name) {
                            selFiles.splice(i, 1);
                        }
                    }
                    dt = new DataTransfer();
                    for (f in selFiles) {
                        var file = selFiles[f];
                        dt.items.add(file);
                    }
                    btnAtt.files = dt.files;
                    var p = ele.parentNode;
                    attZone.removeChild(p)
                }
                div.appendChild(img)
                div.appendChild(btn)
                return div
            }


            //📌신청버튼을 눌렀을때 onclick이벤트
            function insertPtgRegi() {
                let btnCk = $('.btn.btn-primary.w-20.ms-2.crnBtn').val()
                var formData = new FormData($('#ptgRegiFrm')[0])
                for (let i = 0; i < selFiles.length; i++) {
                    formData.append("files", selFiles[i])
                }
                if (btnCk == 'No') {
                    alert('사업자등록번호 인증을 하세요.')
                    return false
                }
                if ($("input:checkbox[name='fdCd']").is(":checked") == false) {
                    alert("활동 분야를 선택하세요.");
                    return;
                }
                $.ajax({
                    url: "/shin/ptgRegiInsert",
                    type: "post",
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (res) {
                        alert("정상적으로 작가 등록이 되었습니다.")
                        location.href = "/"; //등록 되면 홈으로 이동 
                    },
                    error: function (err) {
                        console.log(err)
                    }
                })
                return false;
            }
            
            //정규식 이용한 유효화 검사
        	const errMsg =  "-을 제외한 10자리 숫자를 적어주세요"
        	let regi = "",
        		isCrnValid = false
        	let regiInput = $('#crn')
        	console.log(regiInput.val())
        	let ErrorMsgEl = $('.error-msg')
        	$(regiInput).on('change', () => {
        		let crnRegExp = /^(?=.*[0-9])[0-9]{10}$/
        		regi = $(regiInput).val()
        		if (crnRegExp.test(regi)) { // 정규식 조건 만족 O
        			isCrnValid = true
                    $(ErrorMsgEl).text('')
        		} else { // 정규식 조건 만족 X
        			isCrnValid = false
        			$(regiInput).val('')
        			$(ErrorMsgEl).text(errMsg)
        		}
        	})
        </script>
    </div>
</body>
</html>