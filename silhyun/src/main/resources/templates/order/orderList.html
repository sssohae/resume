<!doctype html>
<html lang="zxx" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{home/layout}">

<head>
    <!-- metas -->
    <meta charset="utf-8">
    <meta name="author" content="pxdraft" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="keywords" content="ShopApp - eCommerce Bootstrap 5 Template" />
    <meta name="description" content="ShopApp - eCommerce Bootstrap 5 Template" />
    <!-- title -->
    <title>κ²°μ κΉμ§€μ™”λ‹¤λ¦¬</title>
    <script src="https://code.jquery.com/jquery-3.6.3.js"
        integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script>
    <!-- iamport.payment.js -->
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<script>
  
</script>
<body>
    <div layout:fragment="content">
        <!-- Skippy & Prload -->
        <!-- skippy -->
        <a id="skippy" class="skippy visually-hidden-focusable overflow-hidden" href="#content">
            <div class="container">
                <span class="u-skiplink-text">Skip to main content</span>
            </div>
        </a>
        <!-- End skippy -->
        <!-- 
    ========================
        Wrapper 
    ========================
    -->
        <div class="wrapper">
            <!-- heder height -->
            <div class="header-height-bar"></div>
            <!-- Main -->
            <main>
                <!-- Breadcrumb -->
                <div class="py-3 bg-gray-100">
                    <div class="container">
                        <div class="row align-items-center">
                            <div class="col-lg-6 my-2">
                                <h1 class="m-0 h4 text-center text-lg-start">π†κ²°μ ν•κΈ°</h1>
                            </div>
                            <div class="col-lg-6 my-2">
                                <ol
                                    class="breadcrumb dark-link m-0 small justify-content-center justify-content-lg-end">
                                    <li class="breadcrumb-item"><a class="text-nowrap" href="/"><i
                                                class="bi bi-home"></i>Home</a></li>
                                    <li class="breadcrumb-item text-nowrap active" aria-current="page">κ²°μ </li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Breadcrumb -->
                <!-- Table -->
                <div class="py-6">
                    <div class="container">
                        <div class="row flex-row-reverse">
                            <!-- sidebar -->
                            <div class="col-lg-5 ps-lg-5">
                                <div class="card">
                                    <div class="card-body">
                                        <ul class="list-unstyled m-0 p-0">
                                            <li class="pb-3 mb-3 border-bottom">
                                                <div class="row align-items-center">
                                                   
                                                    <div class="col-8">
                                                        <!-- Title -->
                                                        <p class="mb-1">
                                                            <a class="text-dark fw-500 opTtl" href="#">μ„ νƒν• μµμ… : [[${optionsVO.ttl}]]</a><br>
                                                           
                                                            <div>μ΄¬μ μΌμ : <span class="m-0 text-muted w-100 d-block shotD" th:text="${#dates.format(reserVO.shotDate, 'yyyy/MM/dd')}">μ΄¬μ μΌμ</span></div>
                                                            <span class="m-0 text-muted w-100 d-block resP">[[${reserVO.resPri}]]</span>
                                                        </p>
                                                    </div>
                                                </div>
                                            </li>
                                        </ul>
                                        <ul class="list-unstyled m-0">
                                            <li class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="me-2 text-body">μ΄ μ„λΉ„μ¤ κΈμ•΅</h6><span
                                                    class="text-end resPri">[[${reserVO.resPri}]]</span>
                                            </li>
                                            <li class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="me-2 text-body">μΏ ν° ν• μΈ</h6><span
                                                    class="text-end cpnPri">-</span>
                                            </li>
                                            <li class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="me-2 text-body">ν¬μΈνΈ μ‚¬μ©</h6><span
                                                    class="text-end pointPri">-</span>
                                            </li>
                                            <li
                                                class="d-flex justify-content-between align-items-center border-top pt-3 mt-3">
                                                <h6 class="me-2">Total</h6><span
                                                    class="text-end text-dark totalM">μ–Όλ§μ›</span>
                                            </li>
                                        </ul>
                                        <label class="form-check-label" for="chbox" >
                                            <input type="checkbox" class="form-check-input" id="chbox" name="orderOK">&nbsp;&nbsp;<span class="text-danger">*</span> μ£Όλ¬Έ λ‚΄μ©μ„ ν™•μΈν•μ€μΌλ©°, κ²°μ μ— λ™μν•©λ‹λ‹¤.(ν•„μ)</label>
                                        <button style="margin-top: 10px;" type="button" class="btn btn-primary w-100" onclick="requestPay()" disabled>κ²°μ ν•κΈ°</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-7" >
                                <div class="card">
                                    <div class="card-header bg-transparent py-3">
                                        <h6 class="m-0 h5">μΏ ν° / ν¬μΈνΈ</h6>
                                    </div>
                                    <div class="card-body" style="padding: 30px;">
                                        <ul class="list-unstyled">
                                            <li class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="me-2 text-body">π μΏ ν°</h6>
                                                <div class="mb-3">
                                                    <select th:if="${!#lists.isEmpty(cpnInfo)}" class="form-select dis" name="discount" required="" style="width: 500px">
                                                        <option value="">μ‚¬μ©κ°€λ¥ν• μΏ ν°</option>
                                                        <option th:each="cpn :${cpnInfo}" th:text="${cpn.cntn}" th:value="${cpn.discount}" th:selected="${cpn.cpnNum}==${reserVO.cpnNum}" th:id="${cpn.cpnNum}"></option>
                                                    </select>
                                                        <select th:if="${#lists.isEmpty(cpnInfo)}" class="form-select dis" name="discount" required="" style="width: 500px">
                                                        	<option>μ‚¬μ©κ°€λ¥ν• μΏ ν°μ΄ μ—†μµλ‹λ‹¤.</option>
                                                        </select>
                                                  
                                                    <div class="invalid-feedback">Please choose your country!</div>
                                                </div>
                                            </li><li>
                                            <div class="pt-2 pb-3 mb-3">
                                                <div class="d-flex">
                                                    <input type="text" placeholder="μ‚¬μ©ν•  ν¬μΈνΈλ¥Ό μ…λ ¥ν•μ„Έμ”"
                                                        class="form-control form-control-sm useP" style="height: 50px;">
                                                   
                                                       <button type="button" class="btn btn-primary btn-sm ms-2 aapP">Apply</button>
                                                     
                                               
                                                </div>
                                            </div>
                                        </li>
                                            <li class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="me-2 text-body">π’° μ‚¬μ©κ°€λ¥ν• ν¬μΈνΈ</h6>
                                                <span class="text-end pointSum" th:if="${pointInfo[0].pointSum}!=0">[[${pointInfo[0].pointSum}]]μ›</span>
                                                <span class="text-end pointSum" th:if="${pointInfo[0].pointSum}==0">0μ›</span>
                                            </li>

                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="accordion accordion-alt pt-4" id="payment-methods">
                                    <div class="card mb-3 shadow-none border">
                                        <div class="card-header p-0 position-relative bg-transparent">
                                            <div class="form-check m-3" data-bs-toggle="collapse"
                                                data-bs-target="#credit-card">
                                                <input class="form-check-input" type="radio" name="flexRadioDefault"
                                                    id="flexRadioDefault1" checked>
                                                <label class="form-check-label h6 m-0 w-100 stretched-link"
                                                    for="flexRadioDefault1">
                                                    ν†µν•© κ²°μ 
                                                </label>
                                            </div>
                                        </div>
                                    </div>
<!--                                     <div class="card mb-3 shadow-none border"> -->
<!--                                         <div class="card-header p-0 position-relative bg-transparent"> -->
<!--                                             <div class="form-check m-3" data-bs-toggle="collapse" -->
<!--                                                 data-bs-target="#credit-card"> -->
<!--                                                 <input class="form-check-input" type="radio" name="flexRadioDefault" -->
<!--                                                     id="flexRadioDefault2"> -->
<!--                                                 <label class="form-check-label h6 m-0 w-100 stretched-link" -->
<!--                                                     for="flexRadioDefault2"> -->
<!--                                                     λ¬΄ν†µμ¥ μ…κΈ -->
<!--                                                 </label> -->
<!--                                             </div> -->
<!--                                         </div> -->
<!--                                     </div> -->
                            
                                </div>
                                <div class="pt-4">
                                    <p class="m-0 pt-3">ν„κΈμμμ¦(μ‚¬μ—…μμ§€μ¶μ¦λΉ™) / μ‹ μ©μΉ΄λ“ λ§¤μ…μ „ν‘λ”  λ§¤μ…μ„Έμ•΅κ³µμ  μ‚¬μ©μ΄ λ¶κ°€λ¥ν•©λ‹λ‹¤.
                                        [λ§¤μ…μ„Έμ•΅κ³µμ  μ•λ‚΄]<br>
                                        ν„κΈμμμ¦ / μ‹ μ©μΉ΄λ“ μμμ¦μ€ κ°μΈ μ†λ“ κ³µμ μ©μΌλ΅λ§ μ‚¬μ©ν•μ‹¤ μ μμµλ‹λ‹¤.</p>
                                </div>
                            </div>
                        </div>
                        <form>
                            <input type="hidden" name="id" th:value="${reserVO.id}">
                            <input type="hidden" name="shotDate" th:value="${#dates.format(reserVO.shotDate, 'yyyy-MM-dd')}">
                            <input type="hidden" name="ptgId" th:value="${reserVO.ptgId}">
                            <input type="hidden" name="shotTime" th:value="${reserVO.shotTime}">
                            <input type="hidden" name="resPri" th:value="${reserVO.resPri}">
                            <input type="hidden" name="opNum" th:value="${selectedOpVO.opNum}">
                            <input type="hidden" name="pname" th:value="${optionsVO.ttl}">
                        </form>
                    </div>
                </div>
                <!--Table -->
            </main>
            <!-- End Main -->

        </div>
        <!-- 
    ========================
       End Wrapper 
    ========================
    -->
        <!-- script start -->
        <!-- jquery -->
        <!-- <script src="/js/jquery-3.5.1.min.js"></script> -->
        <!--bootstrap-->
        <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <!-- slick carousel -->
        <script src="/vendor/swiper/swiper-bundle.min.js"></script>
        <!-- magnific -->
        <script src="/vendor/magnific/jquery.magnific-popup.min.js"></script>
        <!-- isotope -->
        <script src="/vendor/isotope/isotope.pkgd.min.js"></script>
        <!-- count-down -->
        <script src="/vendor/count-down/jquery.countdown.min.js"></script>
        <!-- count-down -->
        <script src="/vendor/jarallax/jarallax-all.js"></script>
        <!-- Theme Js -->
        <script src="/js/custom.js"></script>
        <script src="/js/theme.js"></script>
        <!-- End script start -->
        <script>
            let opTtl = $('.text-dark.fw-500.opTtl').text().replace(',','')
                function cutByMaxStr(str, maxLength) {  
                if (str == undefined || str == null) {
                    return '';
                }

                if (str.length > maxLength) {
                    str = str.substring(0, maxLength) + '...'; 
                    // strμ„ maxLength κΈΈμ΄λ§νΌ μλ¥΄κ³  '.....' μ„ λ’¤μ— λ¶™μΈλ‹¤
                }
                return str;
                 }
            let text = cutByMaxStr(opTtl,25)
            console.log(text)
            $('.text-dark.fw-500.opTtl').text(text)
            let shotD = $('.m-0.text-muted.w-100.d-block.shotD').text()
            console.log(shotD)
            // function getFormatDate(date){
            //     var year = date.getFullYear();              //yyyy
            //     var month = (1 + date.getMonth());          //M
            //     month = month >= 10 ? month : '0' + month;  //month λ‘μλ¦¬λ΅ μ €μ¥
            //     var day = date.getDate();                   //d
            //     day = day >= 10 ? day : '0' + day;          //day λ‘μλ¦¬λ΅ μ €μ¥
            //     return  year + '' + month + '' + day;       //'-' μ¶”κ°€ν•μ—¬ yyyy-mm-dd ν•νƒ μƒμ„± κ°€λ¥
            // }
            // let test = getFormatDate(shotD)
            // console.log(test)
            
            //μ‚¬μ©κ°€λ¥ν• ν¬μΈνΈ
            let resp = $('.m-0.text-muted.w-100.d-block.resP').text()
            let resp2=  Number(resp).toLocaleString()
            let totalIng = $('.text-end.text-dark.totalM').text()
              console.log(resp2)
              $('.m-0.text-muted.w-100.d-block.resP').text(resp2+'μ›')
              $('.text-end.resPri').text(resp2+'μ›')
             
              $('.text-end.text-dark.totalM').text(resp2+'μ›')  //μ΄κ°€κ²©
              //μΏ ν° μ μ©ν• ν• μΈ κΈμ•΅
             let discount = 0;
             $('.form-select').on('change',function(){
                 discount = $(this).val()
                 console.log(discount)
                 let cpnM = (parseInt(resp) * (parseInt(discount) * 0.01))
                 console.log(resp)
                 console.log(resp2)
                 console.log(cpnM)
                
                  $('.text-end.cpnPri').text('-'+Number(cpnM).toLocaleString()+'μ›')
                  $('.text-end.text-dark.totalM').text(Number(resp-cpnM).toLocaleString()+'μ›')   //TotlaκΈμ•΅
                
              })
              //ν¬μΈνΈ μ μ©
              $('.aapP').on('click',function(){
                  let useP = $('.useP').val()
                  let SumP = $('.pointSum').text().replace(/[^0-9]/g,'')
                  if(parseInt(SumP) > parseInt(useP)){
                      $('.text-end.pointPri').text('-'+Number(useP).toLocaleString()+'μ›')
                      $('.pointSum').text(Number(SumP-useP).toLocaleString()+'μ›')  //μ‚¬μ©κ°€λ¥ν• ν¬μΈνΈ
                      
                      //let realtotal = $('.text-end.text-dark.totalM').text().replace(/[^0-9]/g,'') - Number(useP)
                      let realtotal = $('.text-end.text-dark.totalM').text().replace(/[^0-9]/g,'') - Number(useP)
                      console.log(realtotal)
                      console.log(Number(realtotal).toLocaleString()+'μ›')
                      $('.text-end.text-dark.totalM').text(Number(realtotal).toLocaleString()+'μ›') //TotlaκΈμ•΅

                  }else{
                    alert('μ‚¬μ©κ°€λ¥ν• ν¬μΈνΈλ¥Ό μ΄κ³Όν•μ€μµλ‹λ‹¤.')
                    console.log($('.useP').val())
                    $('.useP').val('')
                  }
            
              })

            //ν† νƒ κΈμ•΅
            //let totalPri = resp - cpnM - (SumP-useP)
           // console.log(totalPri)
           let paymPri = Number(0)  //μ΄κΈμ•΅
           let uPoint = Number(0)
           let uCpNum = null;
           let savePo = Number(0)
           //μ²΄ν¬λ°•μ¤ ν΄λ¦­ν•΄μ•Όμ§€ κ²°μ λ²„νΌ ν΄λ¦­ κ°€λ¥
           $(document).ready(function(){
               $("#chbox").change(function(){
                   if($("#chbox").is(":checked")){
                       console.log("μ²΄ν¬λ°•μ¤ μ²΄ν¬ν–μ");
                       $('.btn.btn-primary.w-100').attr("disabled", false)
                       paymPri=  Number($('.text-end.text-dark.totalM').text().replace(/[^0-9]/g,''))  //μ•„μ‘μ¤μ—μ„ μ‚¬μ©ν•  ν• μΈ μ μ© λ κ²°μ κΈμ•΅
                     
                       uPoint = Number($('.useP').val())  //μ‚¬μ© ν¬μΈνΈ 
                    
                       uCpNum = $('.dis :selected').attr('id')  //μ‚¬μ©ν•λ” μΏ ν° λ²νΈ
                       savePo = parseInt(paymPri * 0.01)
                       console.log("μ λ¦½μμ • ν¬μΈνΈ => "+ savePo)
                       
                    }else{
                        console.log("μ²΄ν¬λ°•μ¤ μ²΄ν¬ ν•΄μ ");
                        $('.btn.btn-primary.w-100').attr("disabled", true)
                    }
               
                });
            });

            let list=[];
            //reserν…μ΄λΈ”μ— insertλλ” λ°μ΄ν„°
            let id = $('input[name="id"]').val()     //νμ› μ•„μ΄λ””     
            let shotDate = $('input[name="shotDate"]').val()   //μ΄¬μ λ‚ μ§ 
            let ptgId = $('input[name="ptgId"]').val()  //μ‘κ°€ μ•„μ΄λ””
            let shotTime = $('input[name="shotTime"]').val()   //μ΄¬μ μ‹κ°„ μ½”λ“
            let opNum = $('input[name="opNum"]').val()  //μµμ… λ²νΈ 
            let pname = $('input[name="pname"]').val().replace(',','')  //μƒν’ μ΄λ¦„   
            let ordPri = Number($('.text-end.resPri').text().replace(/[^0-9]/g,''))  //μ£Όλ¬Έ κ°€κ²© (ν• μΈ μ μ©μ „)
           // let savePo = parseInt(paymPri * 0.01)  // μ •μλ§ μ¶”μ¶ν•΄μ„ ν¬μΈνΈλ΅ μ λ¦½ν•κΈ° μ„ν•΄μ„ parseInt μ‚¬μ©  // Number()μ€ μ†μμ  κΉμ§€ μ „μ²΄λ¥Ό λ°ν™ν•¨
            let usePo = uPoint
            console.log(id,shotDate,ptgId,shotTime,paymPri)   
            console.log(paymPri)  
            console.log(uCpNum)
            console.log(uPoint,ordPri)
           
    
            //κ²°μ 
        const IMP = window.IMP; // μƒλµ κ°€λ¥
        IMP.init("imp42851556"); // μ: imp00000000a
            function requestPay() {
                IMP.request_pay({
                pg: 'html5_inicis',  //μ΄λ‹μ‹μ¤ μ½”λ“
                pay_method: "card",   ///κ²°μ  νμ—…μ°½ ν•νƒ
                merchant_uid: 'merchant_' + new Date().getTime(),   // μ£Όλ¬Έλ²νΈ -> λ§¤νΌμ—μ„ μ¦κ°€ν•λ„λ΅
                name: pname,  //μ ν’μ΄λ¦„
                amount: paymPri,                         // μ«μ νƒ€μ…
                buyer_email: "silhyun@silhyun.kr",
                buyer_name: "μ‹¤ν„ν•λ‹¤",  //νλ§¤μ μ΄λ¦„
                buyer_tel: "1231-1231",  
                buyer_addr: "μλ‹΄μ§μ—…μ „λ¬Έν•™κµ",
                buyer_postcode: "0327"
                }, function (rsp) { // callback
                if (rsp.success) {
                    // κ²°μ  μ„±κ³µ μ‹ λ΅μ§
                    let obj={
                            id:id,
                            shotDate:shotDate,
                            ptgId:ptgId,
                            shotTime:shotTime,
                            resPri:paymPri,
                            
                            ctgrNum:ptgId,
                            uCpNum:uCpNum,
                            uPoint:uPoint,
                            paymPri:paymPri,
                            ordPri:ordPri,

                            opNum:opNum, 

                            savePo:savePo,
                            usePo:uPoint,
                            
                            imp_uid: rsp.imp_uid
                        }
                    $.ajax({
                        url: "/pay/reserInsert",
                        method: "post",
                       // headers: { "Content-Type": "application/json" },
                        data:obj
                        
                       //κ³ μ ID
                    }).then((data) => {

                        // μ„λ²„ κ²°μ  API μ„±κ³µμ‹ λ΅μ§
                        let id = $('input[name="id"]').val() 
                        alert("μ •μƒμ μΌλ΅ κ²°μ λμ—μµλ‹λ‹¤.")
                        location.href = "/pay/orderEnd/"+ id
                    })
                } else {
                    // κ²°μ  μ‹¤ν¨ μ‹ λ΅μ§
                    alert(`κ²°μ μ— μ‹¤ν¨ν•μ€μµλ‹λ‹¤. μ—λ¬ λ‚΄μ©: ${rsp.error_msg}`);
                }

                });
            }
        </script>
    </div>
</body>

</html>